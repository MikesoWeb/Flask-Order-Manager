{% extends 'market/layout.html' %}

{% block content %}


<div class="container">
  <h1 class="text-center bg-info">Online Market</h1>
  <div class="row justify-content-center">
    <div class="col-md-10">
      <form id="market-form">
        <div class="mb-3">
          <input type="text" class="form-control" id="user_name" name="user_name" placeholder="Имя пользователя">
        </div>

        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Продукт</th>
              <th>Цена</th>
              <th>Количество</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
              <tr>
                <td>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="product_{{ product.id }}" value="{{ product.id }}" id="product_{{ product.id }}">
                    <label class="form-check-label" for="product_{{ product.id }}">{{ product.name }}</label>
                  </div>
                </td>
                <td>{{ product.price }} руб.</td>
                <td>
                  <div class="input-group">
                    <label class="input-group-text" for="quantity_{{ product.id }}">Количество</label>
                    <input type="number" id="quantity_{{ product.id }}" name="quantity[]" min="1" class="form-control" aria-label="Quantity" aria-describedby="quantity_{{ product.id }}">
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <button id="submit-btn" type="submit" class="btn btn-primary">Создать заказ</button>
      </form>
    </div>
  </div>
</div>

<script>
  const form = document.querySelector('#market-form');
  const submitBtn = document.querySelector('#submit-btn');

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    
    const selectedProducts = document.querySelectorAll('input[type="checkbox"]:checked');
    const data = {
      user_name: document.querySelector('#user_name').value,
      products: [],
      quantities: []
    };

    selectedProducts.forEach((product) => {
      const productId = product.value;
      const quantityInput = document.querySelector(`#quantity_${productId}`);
      const quantity = quantityInput.value;
      data.products.push(productId);
      data.quantities.push(quantity);
    });

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/');
    xhr.setRequestHeader('Content-Type', 'application/json');  // Добавляем заголовок Content-Type
    xhr.onload = () => {
      window.location.href = xhr.responseURL;
    };
    xhr.send(JSON.stringify(data));
  });
</script>


{% endblock content %}